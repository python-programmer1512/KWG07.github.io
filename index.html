<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="style.css">
        <title>Whack A Mole</title>
    </head>
    <body>
        <div class="container">
            <div class="pb_board">
                <div class="problem"><b><span>PROBLEM</span></b></div>
            </div>
            <div class="board">
                <div class="MOLE">
                    <div class="hole">
                        <div class="hole-in"></div>
                        <div class="hole-top"></div>
                        <div class="mole"></div>
                        <div class="hole-bottom"></div>
                    </div>

                </div>
                <div class="MOLE">
                    <div class="hole">
                        <div class="hole-in"></div>
                        <div class="hole-top"></div>
                        <div class="mole"></div>
                        <div class="hole-bottom"></div>
                    </div>

                </div>
                <div class="MOLE">
                    <div class="hole">
                        <div class="hole-in"></div>
                        <div class="hole-top"></div>
                        <div class="mole"></div>
                        <div class="hole-bottom"></div>
                    </div>

                </div>
                <div class="MOLE">
                    <div class="hole">
                        <div class="hole-in"></div>
                        <div class="hole-top"></div>
                        <div class="mole"></div>
                        <div class="hole-bottom"></div>
                    </div>

                </div>
                <div class="MOLE">
                    <div class="hole">
                        <div class="hole-in"></div>
                        <div class="hole-top"></div>
                        <div class="mole"></div>
                        <div class="hole-bottom"></div>
                    </div>

                </div>
                <div class="MOLE">
                    <div class="hole">
                        <div class="hole-in"></div>
                        <div class="hole-top"></div>
                        <div class="mole"></div>
                        <div class="hole-bottom"></div>
                    </div>

                </div>
                <div class="MOLE">
                    <div class="hole">
                        <div class="hole-in"></div>
                        <div class="hole-top"></div>
                        <div class="mole"></div>
                        <div class="hole-bottom"></div>
                    </div>

                </div>
                <div class="MOLE">
                    <div class="hole">
                        <div class="hole-in"></div>
                        <div class="hole-top"></div>
                        <div class="mole"></div>
                        <div class="hole-bottom"></div>
                    </div>

                </div>
                <div class="MOLE">
                    <div class="hole">
                        <div class="hole-in"></div>
                        <div class="hole-top"></div>
                        <div class="mole"></div>
                        <div class="hole-bottom"></div>
                    </div>

                </div>
            </div>

            <div class="score"><b>SCORE: <span>00</span></b></div>
            <div class="timer"><b>TIME : <span>60</span></b></div>
        
        </div>
        <div id="modal" class="modal-overlay">
            <div class="modal-window">
                <div class="title">
                    <h2>Math Game</h2>
                </div>
                <div class="close-area">X</div>
                <div class="content">
                    <p>학번을 입력해주세요(입력 후 엔터)</p>
                    <input type="number" id="school_number" inputmode="numeric" onkeypress="school_number(event)"/>
                </div>
            </div>
        </div>

        <div class="cursor"></div>
        <script>


            const modal = document.getElementById("modal")
            const cursor = document.querySelector('.cursor')
            const holes = [...document.querySelectorAll('.mole')]
            const hole_out = new Array(holes.length).fill(0);
            const mole_ans = new Array(holes.length).fill(0);
            const scoreEl = document.querySelector('.score span')
            const TIMER=document.querySelector('.timer span');
            const PB=document.querySelector('.problem span');
            let score = 0
            let answer = 0 
            let mole_up_time = 5000
            let percent=[1,holes.length]
            let last_percent=[1,holes.length]
            let user_School_Number = 0


            function school_number(e){
                if(e.keyCode == 13){
                    user_School_Number = document.getElementById("school_number").value;
                    console.log(user_School_Number)
                    modal.style.display = "none"
                    game_start()
                    
                }
            }

            function min(a,b){
                if(a>b)return b
                else return a
            }
            function max(a,b){
                if(a<b)return b
                else return a
            }

            function rand(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function new_pb(){
                answer=rand(1,10)
                PB.textContent = answer

            }
            function new_ans(i){
                let random=rand(1,percent[1])
                if(random<=percent[0]){
                    /*answer*/
                    last_percent[0]=percent[0]
                    last_percent[1]=percent[1]
                    last_percent[0]=min(last_percent[0],last_percent[1])
                    percent[0]=1
                    percent[1]++

                    mole_ans[i]=answer
                }else{
                    /*not answer*/
                    let wrong_answer=0;
                    if(rand(1,2)==1){
                        wrong_answer=rand(answer-10,answer-1)
                    }else{
                        wrong_answer=rand(answer+1,answer+10)
                    }
                    mole_ans[i]=wrong_answer
                    percent[0]++


                }

            }


            function game_start(){
                new_pb()
                for(var i=0;i<holes.length;i++){
                    const hole = holes[i]
                    const img = document.createElement('img')
                    img.classList.add('mole-down')
                    img.src = './image/mole.png'
                    img.id = 'mole-movement_'+i
                    
                    hole.appendChild(img)

                    const span = document.createElement('span')
                    let mole_text=document.createTextNode('')
                    span.classList.add('text-down')
                    span.appendChild(mole_text)
                    span.id = 'text-movement_'+i

                    hole.appendChild(span)

                    new_ans(i)



                }

                for(var i=0;i<holes.length;i++){ /* 한번만 실행함 */
                    if(hole_out[i]===0)run(i)
                }
            }

            function mole_move(A,B,i){ /* class : A -> B, down : {A:mole-rise,B:mole-down}, up : {A:mole-down,B:mole-rise} */
                const mole_before_class = "mole-"+A
                const mole_after_class = "mole-"+B

                const text_before_class = "text-"+A
                const text_after_class = "text-"+B

                const before_class = document.getElementById("mole-movement_"+i)
                before_class.classList.replace(mole_before_class,mole_after_class)

                const before_class_text = document.getElementById("text-movement_"+i)
                before_class_text.classList.replace(text_before_class,text_after_class)


            }


            function run(i){

                const hole = holes[i]
                let timer = null
                let uptimer = null

                uptimer = setTimeout(() => { /* 두더지가 올라오기전 대기 시간 */
                    const img = document.getElementsByTagName('img')[i]
                    const span = document.getElementsByTagName('span')[i+1]
                    
                    /* 변경 */
                    span.innerHTML = mole_ans[i];
                    mole_move('down','rise',i)
                    hole_out[i]=1

                    img.addEventListener('click', () => { /* 두더지를 때렸을 때*/
                        if(hole_out[i]===1){
                            hole_out[i]=0
                            if(mole_ans[i]==answer){
                                score += 3
                                mole_up_time=max(2000,5000-(3000/5)*(score/3))
                                new_pb()
                            }else score -= 1
                            scoreEl.textContent = score
                            clearTimeout(timer)
                            mole_move('rise','down',i)

                            new_ans(i)

                            run(i)

                        }
                    })

                    hole.appendChild(img)
                    hole.appendChild(span)

                    timer = setTimeout  (() => { /* 두더지를 때리지 못하고 들어갔을때 */
                    hole_out[i]=0
                        mole_move('rise','down',i)

                        new_ans(i)
                        run(i)
                    }, rand(1000,mole_up_time))

                }, rand(1000,5000))

            }

            window.addEventListener('mousemove', e => {
                cursor.style.top = e.pageY  - cursor.clientHeight/2 + 'px'
                cursor.style.left = e.pageX - cursor.clientWidth/2 + 'px'


            })


            window.addEventListener('mousedown', () => {
                cursor.classList.add('active')
            })
            window.addEventListener('mouseup', () => {
                cursor.classList.remove('active')
                
            })

            window.addEventListener('touchstart', (e) => {
                console.log("touchstart!!!")
                this.touches = e.changedTouches;
                cursor.style.top = this.touches[0].pageY  - cursor.clientHeight/2 + 'px'
                cursor.style.left = this.touches[0].pageX - cursor.clientWidth/2 + 'px'
                cursor.classList.add('active-touch')
            })
            window.addEventListener('touchend', (e) => {
                console.log("touchend!!!")
                this.touches = e.changedTouches;
                cursor.style.top = this.touches[0].pageY  - cursor.clientHeight/2 + 'px'
                cursor.style.left = this.touches[0].pageX - cursor.clientWidth/2 + 'px'
                cursor.classList.remove('active-touch')
                
            })

        </script>
    </body>
</html>